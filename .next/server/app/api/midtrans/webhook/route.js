"use strict";(()=>{var e={};e.id=9311,e.ids=[9311],e.modules={72934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},14300:e=>{e.exports=require("buffer")},6113:e=>{e.exports=require("crypto")},21528:(e,t,r)=>{r.r(t),r.d(t,{headerHooks:()=>w,originalPathname:()=>_,patchFetch:()=>x,requestAsyncStorage:()=>f,routeModule:()=>g,serverHooks:()=>y,staticGenerationAsyncStorage:()=>h,staticGenerationBailout:()=>S});var n={};r.r(n),r.d(n,{POST:()=>l,runtime:()=>c});var a=r(95419),s=r(69108),i=r(99678),o=r(78070),u=r(42509),d=r(6113),p=r.n(d);let c="nodejs";async function l(e){try{let t=await e.json(),r=(0,u.lx)(),n=e.headers.get("x-midtrans-signature"),a=process.env.MIDTRANS_SERVER_KEY||"";if(!a)return o.Z.json({error:"MIDTRANS_SERVER_KEY is not configured"},{status:500});let{order_id:s,status_code:i,gross_amount:d}=t||{};if(n&&s&&i&&d){let e=`${s}${i}${d}${a}`,t=p().createHash("sha512").update(e).digest("hex");if(n!==t)return o.Z.json({error:"Invalid signature"},{status:401})}let{order_id:c,transaction_status:l,fraud_status:g,payment_type:f}=t,{data:h,error:y}=await r.from("payments").select("*").eq("id",c).single();if(y||!h)return console.error("Payment not found:",c),o.Z.json({error:"Payment not found"},{status:404});return"settlement"===l||"capture"===l?"accept"===g?await m(r,h,t):"challenge"===g?await r.from("payments").update({status:"pending",updated_at:new Date().toISOString()}).eq("id",c):await r.from("payments").update({status:"failed",updated_at:new Date().toISOString()}).eq("id",c):"pending"===l?await r.from("payments").update({status:"pending",updated_at:new Date().toISOString()}).eq("id",c):("deny"===l||"expire"===l||"cancel"===l)&&await r.from("payments").update({status:"failed",updated_at:new Date().toISOString()}).eq("id",c),o.Z.json({status:"ok"})}catch(e){return console.error("Webhook error:",e),o.Z.json({error:"Internal server error"},{status:500})}}async function m(e,t,r){try{await e.from("payments").update({status:"paid",paid_at:new Date().toISOString(),updated_at:new Date().toISOString()}).eq("id",t.id);let r=function(e){if(e.includes("1 Month")||e.includes("30 days"));else if(e.includes("3 Months")||e.includes("90 days"))return 90;else if(e.includes("1 Year")||e.includes("365 days"))return 365;return 30}(t.description),n=new Date;n.setDate(n.getDate()+r);let a=function(e){if(e.includes("1 Month")||e.includes("30 days"));else if(e.includes("3 Months")||e.includes("90 days"))return"3months";else if(e.includes("1 Year")||e.includes("365 days"))return"1year";return"1month"}(t.description),{error:s}=await e.from("profiles").update({membership_type:"premium",subscription_start:new Date().toISOString(),subscription_end:n.toISOString(),subscription_plan:a,updated_at:new Date().toISOString()}).eq("id",t.user_id);s&&console.error("Error updating profile:",s),console.log(`User ${t.user_id} upgraded to premium until ${n.toISOString()}`)}catch(e){console.error("Error handling successful payment:",e)}}let g=new a.AppRouteRouteModule({definition:{kind:s.x.APP_ROUTE,page:"/api/midtrans/webhook/route",pathname:"/api/midtrans/webhook",filename:"route",bundlePath:"app/api/midtrans/webhook/route"},resolvedPagePath:"/Users/rikorizky/Documents/Aplikasi Trading/Trading/src/app/api/midtrans/webhook/route.ts",nextConfigOutput:"",userland:n}),{requestAsyncStorage:f,staticGenerationAsyncStorage:h,serverHooks:y,headerHooks:w,staticGenerationBailout:S}=g,_="/api/midtrans/webhook/route";function x(){return(0,i.patchFetch)({serverHooks:y,staticGenerationAsyncStorage:h})}},42509:(e,t,r)=>{r.d(t,{VL:()=>i,XU:()=>u,lx:()=>s});var n=r(57699),a=r(32455);let s=()=>{let e=(0,a.cookies)();return(0,n.createServerComponentClient)({cookies:()=>e})};async function i(){let e=s(),{data:{user:t},error:r}=await e.auth.getUser();return r?(console.error("Error getting user:",r),null):t}async function o(e){let t=s(),{data:r,error:n}=await t.from("profiles").select("*").eq("id",e).single();return n?(console.error("Error getting profile:",n),null):r}async function u(e){if(!e)return!1;let t=await o(e);return!!t&&"premium"===t.membership_type&&(!t.membership_expires_at||new Date(t.membership_expires_at)>new Date)}}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),n=t.X(0,[6225,6349,6206],()=>r(21528));module.exports=n})();