"use strict";(()=>{var e={};e.id=4070,e.ids=[4070,2745],e.modules={72934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},39491:e=>{e.exports=require("assert")},14300:e=>{e.exports=require("buffer")},57147:e=>{e.exports=require("fs")},12781:e=>{e.exports=require("stream")},73837:e=>{e.exports=require("util")},59796:e=>{e.exports=require("zlib")},39892:(e,t,r)=>{r.r(t),r.d(t,{headerHooks:()=>h,originalPathname:()=>w,patchFetch:()=>_,requestAsyncStorage:()=>f,routeModule:()=>l,serverHooks:()=>g,staticGenerationAsyncStorage:()=>m,staticGenerationBailout:()=>y});var n={};r.r(n),r.d(n,{POST:()=>p,runtime:()=>d});var a=r(95419),s=r(69108),i=r(99678),o=r(78070),c=r(42509),u=r(12745);let d="nodejs";async function p(e){try{let{amount:t,description:r,userId:n}=await e.json();if(!t||!r||!n)return o.Z.json({success:!1,error:"Missing required fields"},{status:400});let a=(0,c.lx)(),{data:{user:s},error:i}=await a.auth.getUser();if(i||!s||s.id!==n)return o.Z.json({success:!1,error:"Unauthorized"},{status:401});let d=`PAY_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,p=await (0,u.T)(d,t,r),{error:l}=await a.from("payments").insert({id:d,user_id:n,amount:t,description:r,status:"pending",payment_method:"qris",expires_at:new Date(Date.now()+9e5).toISOString(),created_at:new Date().toISOString()});if(l)return console.error("Error creating payment:",l),o.Z.json({success:!1,error:"Failed to create payment"},{status:500});return o.Z.json({success:!0,paymentId:d,qrCode:p,expiresAt:new Date(Date.now()+9e5).toISOString()})}catch(e){return console.error("Payment creation error:",e),o.Z.json({success:!1,error:"Internal server error"},{status:500})}}let l=new a.AppRouteRouteModule({definition:{kind:s.x.APP_ROUTE,page:"/api/payment/create/route",pathname:"/api/payment/create",filename:"route",bundlePath:"app/api/payment/create/route"},resolvedPagePath:"/Users/rikorizky/Documents/Aplikasi Trading/Trading/src/app/api/payment/create/route.ts",nextConfigOutput:"",userland:n}),{requestAsyncStorage:f,staticGenerationAsyncStorage:m,serverHooks:g,headerHooks:h,staticGenerationBailout:y}=l,w="/api/payment/create/route";function _(){return(0,i.patchFetch)({serverHooks:g,staticGenerationAsyncStorage:m})}},12745:(e,t,r)=>{r.d(t,{T:()=>a,verifyPayment:()=>d});let n={midtrans:{serverKey:process.env.MIDTRANS_SERVER_KEY,clientKey:process.env.MIDTRANS_CLIENT_KEY,isProduction:"production"===(process.env.MIDTRANS_ENV||"").toLowerCase()||"sandbox"!==(process.env.MIDTRANS_ENV||"").toLowerCase()},xendit:{secretKey:process.env.XENDIT_SECRET_KEY,publicKey:process.env.XENDIT_PUBLIC_KEY,callbackToken:process.env.XENDIT_CALLBACK_TOKEN},dana:{merchantId:process.env.DANA_MERCHANT_ID,secretKey:process.env.DANA_SECRET_KEY}};async function a(e,t,r,n="custom"){switch(n){case"midtrans":return i(e,t,r);case"xendit":return o(e,t,r);case"dana":return c(e,t,r);default:return s(e,t,r)}}async function s(e,t,n){let a={paymentId:e,amount:t,description:n,timestamp:Date.now(),merchantName:"Trading Platform"};try{let e=r(77670);return await e.toDataURL(JSON.stringify(a),{width:256,margin:2,color:{dark:"#000000",light:"#FFFFFF"}})}catch(r){return console.error("QR Code generation failed:",r),u(e,t)}}async function i(e,t,r){let{serverKey:a,isProduction:s}=n.midtrans;if(!a)throw Error("Midtrans server key not configured");try{let n=await fetch("https://api.midtrans.com/v2/qris",{method:"POST",headers:{Accept:"application/json","Content-Type":"application/json",Authorization:`Basic ${Buffer.from(a+":").toString("base64")}`},body:JSON.stringify({transaction_details:{order_id:e,gross_amount:t},item_details:[{id:"premium-subscription",price:t,quantity:1,name:r}],qris:{acquirer:"gopay"}})}),s=await n.json();if("201"===s.status_code)return s.qr_string;throw Error(`Midtrans error: ${s.status_message}`)}catch(r){return console.error("Midtrans QRIS generation failed:",r),u(e,t)}}async function o(e,t,r){let{secretKey:a}=n.xendit;if(!a)throw Error("Xendit secret key not configured");try{let n=await fetch("https://api.xendit.co/qr_codes",{method:"POST",headers:{Authorization:`Basic ${Buffer.from(a+":").toString("base64")}`,"Content-Type":"application/json"},body:JSON.stringify({reference_id:e,type:"DYNAMIC",currency:"IDR",amount:t,description:r})}),s=await n.json();if(s.id)return s.qr_string;throw Error(`Xendit error: ${s.message}`)}catch(r){return console.error("Xendit QRIS generation failed:",r),u(e,t)}}async function c(e,t,r){let{merchantId:a,secretKey:s}=n.dana;if(!a||!s)throw Error("DANA credentials not configured");return u(e,t)}function u(e,t){return`data:image/svg+xml;base64,${Buffer.from(`
    <svg width="256" height="256" xmlns="http://www.w3.org/2000/svg">
      <rect width="256" height="256" fill="white"/>
      <text x="128" y="128" text-anchor="middle" font-family="monospace" font-size="12">
        QRIS Payment
        ${e}
        Rp ${t.toLocaleString()}
      </text>
    </svg>
  `).toString("base64")}`}async function d(e,t="midtrans"){switch(t){case"midtrans":return p(e);case"xendit":return l(e);case"dana":return f(e);default:return m(e)}}async function p(e){let{serverKey:t,isProduction:r}=n.midtrans;try{let n=await fetch(`${r?"https://api.midtrans.com":"https://api.sandbox.midtrans.com"}/v2/${e}/status`,{headers:{Authorization:`Basic ${Buffer.from(t+":").toString("base64")}`}}),a=await n.json();if("settlement"===a.transaction_status||"capture"===a.transaction_status)return{status:"paid",transactionId:String(a.transaction_id||"")};if("pending"===a.transaction_status)return{status:"pending"};return{status:"failed"}}catch(e){return console.error("Midtrans verification failed:",e),{status:"failed"}}}async function l(e){let{secretKey:t}=n.xendit;try{let r=await fetch(`https://api.xendit.co/qr_codes/${e}`,{headers:{Authorization:`Basic ${Buffer.from(t+":").toString("base64")}`}}),n=await r.json();if("COMPLETED"===n.status)return{status:"paid",transactionId:String(n.id||"")};if("PENDING"===n.status)return{status:"pending"};return{status:"failed"}}catch(e){return console.error("Xendit verification failed:",e),{status:"failed"}}}async function f(e){return m(e)}async function m(e){return Math.random()>.7?{status:"paid",transactionId:`TXN_${Date.now()}`}:{status:"pending"}}},42509:(e,t,r)=>{r.d(t,{VL:()=>i,XU:()=>c,lx:()=>s});var n=r(57699),a=r(32455);let s=()=>{let e=(0,a.cookies)();return(0,n.createServerComponentClient)({cookies:()=>e})};async function i(){let e=s(),{data:{user:t},error:r}=await e.auth.getUser();return r?(console.error("Error getting user:",r),null):t}async function o(e){let t=s(),{data:r,error:n}=await t.from("profiles").select("*").eq("id",e).single();return n?(console.error("Error getting profile:",n),null):r}async function c(e){if(!e)return!1;let t=await o(e);return!!t&&"premium"===t.membership_type&&(!t.membership_expires_at||new Date(t.membership_expires_at)>new Date)}}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),n=t.X(0,[6225,6349,6206,7670],()=>r(39892));module.exports=n})();